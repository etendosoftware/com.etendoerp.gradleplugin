def updateCommitStatus(repositoryName, status, description, accessToken, gitCommit, buildUrl, contextBuild) {
  sh "./pipelines/utils/build-update.sh ${repositoryName} ${status} \"${description}\" ${accessToken} ${gitCommit} ${buildUrl} \"${contextBuild}\""
}

pipeline {
  options {
    disableConcurrentBuilds()
    buildDiscarder(logRotator(numToKeepStr: '7', artifactNumToKeepStr: '7'))
  }

  environment {
    CONTEXT_NAME    = "etendo"
    BBDD_SID        = "etendo"
    BBDD_SID2       = "etendo2"
    BBDD_PORT       = "5432"
    BBDD_SYSTEMUSER = "postgres"
    BBDD_SYSTEMPASS = "syspass"
    BBDD_USER       = "tad"
    BBDD_PASSWORD   = "tad"
    NEXUS_USER      = credentials('nexus-admin-user')
    NEXUS_PASSWORD  = credentials('nexus-admin-passwd')
    GITHUB_USER     = "etendobot"
    GITHUB_TOKEN    = credentials('github-read-package-token')
    EMAIL_ADDRESS   = credentials('email_builds')

    URL_ORG_GITHUB  = "https://github.com/etendosoftware"
    ETENDO_BASE_URL = "https://github.com/etendosoftware/etendo_base"
    PLUGIN_URL      = " https://github.com/etendosoftware/com.etendoerp.gradleplugin.git"

    SUCCESS         = "SUCCESS"
    FAILED          = "FAILED"
    UNSTABLE        = "UNSTABLE"
    ABORTED         = "ABORTED"

    ETENDO_DIR      = "etendo_base"
    REPOSITORY_NAME = "com.etendoerp.gradleplugin"

    ACCESS_TOKEN = credentials('access_token_github')
      
    COMMIT_INPROGRESS_STATUS = "pending"
    COMMIT_SUCCESS_STATUS    = "success"
    COMMIT_FAILED_STATUS     = "failure"

    CONTEXT_BUILD = "Testing Compilation in JAR and Source Format"

    JAVA_HOME           = "/usr/lib/jvm/jdk-17.0.13"

    BASE_BRANCH_BACKPORT = "release/24.4"
    MAIN_BRANCH          = "main"
    DEVELOP_BRANCH       = "develop"

    TRUE  = 'true'
    FALSE = 'false'

    ADD_BUNDLES = 'true'
  }

  agent {
    kubernetes {
        inheritFrom 'jenkins-node-compile'
        defaultContainer 'jnlp'
        yamlFile 'pipelines/utils/AgentTestCompile.yaml'
    }
  }

  stages {
    stage('Check Pipeline Skip Condition') { // MARK: Check Pipeline Skip Condition
      steps {
        script {
          try {
            echo "---------------------- Setting up Environment Variables ----------------------"
            env.STATUS_TEST = SUCCESS // Overall status of the tests
            env.JACOCO_REPORT_EXISTS = FALSE // Flag to indicate if Jacoco report exists
            env.FAILED_SUITES = "" // List to collect failed test suites
            
            echo "--------------- Printenv ---------------"
            sh 'printenv'

            echo "--------------- Checking if pipeline should be skipped ---------------"
            def changedFiles = sh(
              script: "git diff --name-only HEAD~1 HEAD",
              returnStdout: true
            ).trim()
            
            echo "Files changed in last commit: ${changedFiles}"
            
            // Check if only JenkinsFileTestCompile was changed
            def filesList = changedFiles.split('\n')
            def onlyTestCompileJenkinsfile = filesList.every { it == "pipelines/JenkinsFile" || it == "pipelines/utils/AgentTests.yaml" } && filesList.size() > 0 && filesList.size() <= 2

            if (onlyTestCompileJenkinsfile) {
              echo "‚è≠Ô∏è Only pipeline/JenkinsFile related files were changed. Skipping pipeline execution."
              env.DESCRIPTION = "Pipeline Skipped - Only JenkinsFileTestCompile files changed"
              updateCommitStatus(REPOSITORY_NAME, COMMIT_SUCCESS_STATUS, env.DESCRIPTION, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
              
              echo "‚úÖ Pipeline execution aborted successfully. Commit marked as success."
              currentBuild.result = ABORTED
              return
            } else {
              echo "‚úÖ Pipeline will continue - Changes detected in other files or multiple files changed."
              currentBuild.result = SUCCESS
            }
        } catch (Exception e) {
          echo "‚ùå Error in pipeline skip condition check: ${e.getMessage()}"            
          env.DESCRIPTION = "Pipeline Check Failed"
          updateCommitStatus(REPOSITORY_NAME, COMMIT_INPROGRESS_STATUS, env.DESCRIPTION, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
          currentBuild.result = FAILED
          error("Failed to check pipeline skip condition: ${e.getMessage()}")
        }
      }
    }
  }
    stage ('Build Environment with Etendo Classic in JAR format') { // MARK: Build Environment with Etendo Classic in JAR format
      when {
        expression { currentBuild.result == SUCCESS }
      }
      steps {
        container('compiler') {
          script {
            try {
              echo "---------------- Build JAR Environment ----------------"
              def rootDir = pwd()
              def infoCommit = load "${rootDir}/pipelines/utils/infoCommits.groovy"

              echo "-------------------------- Selecting the Correct Branch for Etendo Base Cloning --------------------------"
              env.BASE_BRANCH = env.MAIN_BRANCH
              if (env.GIT_BRANCH.contains("-Y")) {
                echo "The branch ${GIT_BRANCH} contains a -Y suffix."
                def yearCommitBranch = (GIT_BRANCH =~ /-Y(\d{2})/)?.find() ? (GIT_BRANCH =~ /-Y(\d{2})/)[0][1] : null
                def yearBackportBranch = (env.BACKPORT_BRANCH =~ /release\/(\d{2})\./)?.find() ? (env.BACKPORT_BRANCH =~ /release\/(\d{2})\./)[0][1] : null
                if (yearCommitBranch && yearBackportBranch) {
                  if (yearCommitBranch == yearBackportBranch) {
                    env.BASE_BRANCH = env.BACKPORT_BRANCH
                  }
                } else {
                  echo "Could not extract the year from GIT_BRANCH or env.BACKPORT_BRANCH."
                }
              }
              echo "-------------------------- etendo_base branch name: ${env.BASE_BRANCH} --------------------------"

              def description = "Compiling Environment in JAR"
              updateCommitStatus(REPOSITORY_NAME, COMMIT_INPROGRESS_STATUS, description, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)

              echo "--------------- Building Etendo JAR Environment ----------------"
              sh """
              git clone --branch ${BASE_BRANCH} ${ETENDO_BASE_URL}
              cd ${ETENDO_DIR}

              echo "\n
              context.name=${CONTEXT_NAME}
              bbdd.sid=${BBDD_SID}
              bbdd.port=${BBDD_PORT}
              bbdd.systemUser=${BBDD_SYSTEMUSER}
              bbdd.systemPassword=${BBDD_SYSTEMPASS}
              bbdd.user=${BBDD_USER}
              bbdd.password=${BBDD_PASSWORD}
              nexusUser=${NEXUS_USER}
              nexusPassword=${NEXUS_PASSWORD}
              githubUser=${GITHUB_USER}
              githubToken=${GITHUB_TOKEN}
              allow.root=true
              org.gradle.vfs.watch=false
              org.gradle.jvmargs=-Dfile.encoding=UTF-8" > gradle.properties
              """

              sh """
              cd ${ETENDO_DIR}
              git clone ${PLUGIN_URL} buildSrc
              cd buildSrc
              git checkout ${GIT_COMMIT}
              cp gradle.properties.template gradle.properties
              """

              echo "---------------- Disable Tests ----------------"
              env.PLUGIN_DIR = "${ETENDO_DIR}/buildSrc"
              sh """
              cd ${PLUGIN_DIR}
              sed -i 's/test\\.onlyIf { *true *}/test.onlyIf { false }/' build.gradle
              """

              echo "-------------------------- Commit Information Collected --------------------------"
              def commitInfoTemplate = infoCommit.generateCommitInfo(env.URL_ORG_GITHUB, null, REPOSITORY_NAME, true, env.PLUGIN_DIR)
              env.COMMIT_INFO_TEMPLATE = "${commitInfoTemplate}"
              echo "${env.COMMIT_INFO_TEMPLATE}"

              sh """
              sed -i "s/\\(id 'com.etendoerp.gradleplugin[^']*'\\) version '\\([^']*\\)'/\\1 \\/\\/ version '\\2'/" "\${ETENDO_DIR}/build.gradle"
              """

              if (env.ADD_BUNDLES == TRUE) {
                echo "---------------- Add Bundles dependencies ----------------"
                def dependencies = env.DEPENDENCIES_FOR_BASE.split(',')
                
                def dependenciesBlock = dependencies.collect {
                    "moduleDeps(\"com.etendoerp:$it:[3.0.0,4.0.0)@zip\") {transitive=true}"
                }.join('\n')

                def buildGradleContent = """
                dependencies {
                    ${dependenciesBlock}
                }
                """              

                sh """
                cd ${ETENDO_DIR}
                echo '${buildGradleContent}' >> build.gradle
                cat build.gradle
                """
              } else {
                echo "---------------- Skipping Adding Bundles ----------------"
              }
              
              echo "---------------- Build & Compile ----------------"
              sh """
              cd etendo_base
              echo "y" > yes
              ./gradlew expandModules --info < yes
              ./gradlew prepareConfig --info
              ./gradlew setup --info
              ./gradlew install --info
              ./gradlew update.database
              ./gradlew compile.complete
              ./gradlew smartbuild --info
              """

              echo "---------------- Cleaning Gradle cache and workspace ----------------"
              sh """
                rm -rf /home/jenkins/.gradle/caches
                rm -rf ${ETENDO_DIR}
              """
              echo "---------------- Build JAR Environment Succesful ----------------"
              currentBuild.result = SUCCESS
            } catch (Exception e) {
              echo "---------------- Build JAR Environment Failed ----------------"
              def description = "Compiling Environment in JAR Failed"
              updateCommitStatus(REPOSITORY_NAME, COMMIT_FAILED_STATUS, description, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
              echo "Exception occurred: " + e.toString()
              currentBuild.result = UNSTABLE
              env.BUILD_IN_JAR_STATUS = FAILED
              unstable('Build Failed in Etendo JAR Environment')
            }
          }
        }
      }
    }
    stage ('Build Environment with Etendo Classic in Source format') { // MARK: Build Environment with Etendo Classic in Source format
      when {
        expression { currentBuild.result == SUCCESS || currentBuild.result == UNSTABLE }
      }
      steps {
        container('compiler') {
          script {
            try {
              def description = "Compiling Environment in Source"
              updateCommitStatus(REPOSITORY_NAME, COMMIT_INPROGRESS_STATUS, description, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
              echo "---------------- Build Source Environment ----------------"

              echo "---------------- Print Environment ----------------"
              sh "printenv"

              echo "--------------- Building Etendo Source Environment ----------------"
              sh """
              git clone --branch ${BASE_BRANCH} ${ETENDO_BASE_URL}
              cd ${ETENDO_DIR}

              echo "\n
              context.name=${CONTEXT_NAME}
              bbdd.sid=${BBDD_SID2}
              bbdd.port=${BBDD_PORT}
              bbdd.systemUser=${BBDD_SYSTEMUSER}
              bbdd.systemPassword=${BBDD_SYSTEMPASS}
              bbdd.user=${BBDD_USER}
              bbdd.password=${BBDD_PASSWORD}
              nexusUser=${NEXUS_USER}
              nexusPassword=${NEXUS_PASSWORD}
              githubUser=${GITHUB_USER}
              githubToken=${GITHUB_TOKEN}
              allow.root=true
              org.gradle.vfs.watch=false
              org.gradle.jvmargs=-Dfile.encoding=UTF-8" > gradle.properties
              """

              sh """
              cd ${ETENDO_DIR}
              git clone ${PLUGIN_URL} buildSrc
              cd buildSrc
              git checkout ${GIT_COMMIT}
              cp gradle.properties.template gradle.properties
              """

              echo "---------------- Disable Tests ----------------"
              sh """
              cd ${PLUGIN_DIR}
              sed -i 's/test\\.onlyIf { *true *}/test.onlyIf { false }/' build.gradle
              cat build.gradle
              """

              sh """
              sed -i "s/\\(id 'com.etendoerp.gradleplugin[^']*'\\) version '\\([^']*\\)'/\\1 \\/\\/ version '\\2'/" "\${ETENDO_DIR}/build.gradle"
              """

              if (env.ADD_BUNDLES == TRUE) {
                echo "---------------- Add Bundles dependencies ----------------"
                def dependencies = env.DEPENDENCIES_FOR_BASE.split(',')
                
                def dependenciesBlock = dependencies.collect {
                    "moduleDeps(\"com.etendoerp:$it:[3.0.0,4.0.0)@zip\") {transitive=true}"
                }.join('\n')

                dependenciesBlock += "\nimplementation(\"com.etendoerp.platform:etendo-core:[25.1.0,26.1.0)\")"

                def buildGradleContent = """
                dependencies {
                    ${dependenciesBlock}
                }
                """              

                sh """
                cd ${ETENDO_DIR}
                echo '${buildGradleContent}' >> build.gradle
                cat build.gradle
                """
              } else {
                echo "---------------- Skipping Adding Bundles ----------------"
              }
              
              echo "---------------- Build & Compile ----------------"
              sh """
              cd etendo_base
              echo "y" > yes
              ./gradlew expandCore --info < yes
              ./gradlew expandModules --info < yes
              ./gradlew prepareConfig --info
              ./gradlew setup --info
              ./gradlew install --info
              ./gradlew update.database
              ./gradlew compile.complete
              ./gradlew smartbuild --info
              """

              echo "---------------- Build Source Environment Succesful ----------------"
              currentBuild.result = SUCCESS
            } catch (Exception e) {
              echo "---------------- Build Source Environment Failed ----------------"
              description = "Compiling Environment in Source Failed"
              updateCommitStatus(REPOSITORY_NAME, COMMIT_FAILED_STATUS, description, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
              echo "Exception occurred: " + e.toString()
              currentBuild.result = UNSTABLE
              env.BUILD_IN_SOURCE_STATUS = FAILED
              unstable('Build Failed in Etendo Source Environment')
            }
          }
        }
      }
    }
  }
  
  post {
    success {
      script {
        echo "---------------- DONE ----------------"
        description = "Compilation Environment Successful"
        updateCommitStatus(REPOSITORY_NAME, COMMIT_SUCCESS_STATUS, "Compilation Environment Successful", ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
      }
    }
    unstable {
      script {
        echo "---------------- UNSTABLE ----------------"
        env.DESCRIPTION = "Build Environments Unstable"
        def statusMessage = ""
        if (env.BUILD_IN_JAR_STATUS == FAILED) {
          statusMessage += "Error in building the environment in JAR"
        }
        if (env.BUILD_IN_SOURCE_STATUS == FAILED) {
          if (statusMessage != "") {
            statusMessage += " and Source."
          } else {
            statusMessage += "Error in building the environment in Source."
          }
          env.ERROR_MESSAGE = "‚ùå <strong>${statusMessage}</strong><br>"
        }
        updateCommitStatus(REPOSITORY_NAME, COMMIT_FAILED_STATUS, env.DESCRIPTION, ACCESS_TOKEN, GIT_COMMIT, BUILD_URL, CONTEXT_BUILD)
      }
      mail to: EMAIL_ADDRESS,
      subject: "‚ö†Ô∏è ${env.DESCRIPTION} - ${currentBuild.fullDisplayName}",
      mimeType: "text/html",
      body:  """
        <html>
          <head>
              <style>
                  body { font-family: 'Arial', sans-serif; }
                  .header { font-size: 16px; font-weight: bold; color: #333; }
              </style>
          </head>
          <body>
            <p><em>${new Date()}</em></p>
            <p>__________________________________________________________</p>

            <h2 class="header">‚ö†Ô∏è ${env.DESCRIPTION}</h2>

            <p>${env.ERROR_MESSAGE ?: ""}</p>

            ${env.COMMIT_INFO_TEMPLATE}

            <p>The build has failed unexpectedly.<br>To more information on the failing run visit: ${env.BUILD_URL}</p>

            <p class="footer"><em>Best regards,<br>#EtendoBot ü§ñ</em></p>
            <p>__________________________________________________________</p>
          </body>
        </html>
      """
    }
  }
}
